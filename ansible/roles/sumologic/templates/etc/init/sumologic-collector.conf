description "SumoLogic Collector"
start on (started docker)
stop on runlevel [!2345]

respawn

respawn limit 100 1

# Needed to find /root/.dockercfg
env HOME="/root"
env IMAGE="sumologic/collector:latest-file"
export HOME

pre-start script
    echo "[$(date)] Starting $JOB"
    /usr/bin/docker pull $IMAGE || true
    /usr/bin/docker rm sumologic-collector || true
end script

exec /usr/bin/docker run \
    --name="sumologic-collector" \
    --volume="/var/lib/docker:/logs:ro" \
    --volume="/etc/sumo-sources.json:/etc/sumo-sources.json:ro" \
    --restart=always \
    --env="SUMO_ACCESS_ID={{sumologic_access_id}}" \
    --env="SUMO_ACCESS_KEY={{sumologic_access_key}}" \
    --env="SUMO_COLLECTOR_NAME={{sumologic_collector_name}}" \
    --cap-add=SYS_PTRACE \
    --security-opt=apparmor:unconfined \
    sumologic/collector:latest-file

post-stop script
    /usr/bin/docker stop -t 2 sumologic-collector || true
    /usr/bin/docker rm sumologic-collector || true
    sleep 2
end script
